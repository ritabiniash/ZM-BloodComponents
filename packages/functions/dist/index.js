!function(e,t){for(var o in t)e[o]=t[o];t.__esModule&&Object.defineProperty(e,"__esModule",{value:!0})}(exports,(()=>{"use strict";var e={311:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),t.Collections=void 0,(o=t.Collections||(t.Collections={})).ADMIN="admin",o.DONORS="donors",o.APPOINTMENTS="appointments"},685:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const n=o(576);t.handler=function(e){return n.https.onCall((async(t,o)=>await e(t,o)))}},398:(e,t)=>{var o,n,i,r;Object.defineProperty(t,"__esModule",{value:!0}),t.DonationType=t.Hospital=t.AdminRole=t.BloodType=void 0,(r=t.BloodType||(t.BloodType={}))[r.O_PLUS=0]="O_PLUS",r[r.O_MINUS=1]="O_MINUS",r[r.A_PLUS=2]="A_PLUS",r[r.A_MINUS=3]="A_MINUS",r[r.B_PLUS=4]="B_PLUS",r[r.B_MINUS=5]="B_MINUS",r[r.AB_PLUS=6]="AB_PLUS",r[r.AB_MINUS=7]="AB_MINUS",(i=t.AdminRole||(t.AdminRole={})).SYSTEM_USER="SYSTEM_USER",i.ZM_MANAGER="ZM_MANAGER",i.ZM_COORDINATOR="ZM_COORDINATOR",i.HOSPITAL_COORDINATOR="HOSPITAL_COORDINATOR",(n=t.Hospital||(t.Hospital={})).TEL_HASHOMER="TEL_HASHOMER",n.ASAF_HAROFE="ASAF_HAROFE",(o=t.DonationType||(t.DonationType={}))[o.Thrombocytes=0]="Thrombocytes",o[o.Granulocytes=1]="Granulocytes"},979:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(311),i=o(563),r=o(54);t.default=async function(e,t){var o;const a=await i.validateAppointmentEditPermissions(null===(o=t.auth)||void 0===o?void 0:o.uid,[e.hospital]),s=e.slots,d={creationTime:r.firestore.Timestamp.fromDate(new Date),creatorUserId:a,donationStartTime:r.firestore.Timestamp.fromDate(new Date(e.donationStartTime)),hospital:e.hospital},l=r.firestore().batch(),c=r.firestore().collection(n.Collections.APPOINTMENTS);for(let e=0;e<s;e++)l.set(c.doc(),d);return await l.commit(),s}},946:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(563),i=o(988);t.default=async function(e,t){var o;const r=e.appointmentIds,a=(await i.getAppointmentsByIds(r)).map((e=>e.hospital));return await n.validateAppointmentEditPermissions(null===(o=t.auth)||void 0===o?void 0:o.uid,a),await i.deleteAppointmentsByIds(r),r.length}},762:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(398),i=o(752);t.default=async function(e,t){var o;await async function(e){if(!e)throw new Error("User must be authenticated to edit admins");const t=await i.getAdmin(e);if(!t)throw Error("User is not an admin and can't edit admins");if(!function(e){for(const t in e.roles)switch(e.roles[t]){case n.AdminRole.SYSTEM_USER:case n.AdminRole.ZM_MANAGER:return!0}return!1}(t))throw Error("User role is not authorized to edit admins")}(null===(o=t.auth)||void 0===o?void 0:o.uid),await i.setAdmin(e.admin)}},563:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validateAppointmentEditPermissions=void 0;const n=o(398),i=o(804),r=o(752);t.validateAppointmentEditPermissions=async function(e,t){if(!e)throw new Error("User must be authenticated to edit appointments");const o=await r.getAdmin(e);if(!o)throw console.error("Could not find calling user",e),Error("User is not an admin and can't edit appointments");if(!function(e,t){if(e.roles.includes(n.AdminRole.SYSTEM_USER))return!0;if(e.roles.includes(n.AdminRole.HOSPITAL_COORDINATOR)&&i.intersection(e.hospitals,t).length==t.length)return!0;for(const o in e.roles)switch(e.roles[o]){case n.AdminRole.SYSTEM_USER:return!0;case n.AdminRole.HOSPITAL_COORDINATOR:if(i.intersection(e.hospitals,t).length>0)return!0}return!1}(o,t))throw console.error("User",e,"role does not allow adding appointments to",t),Error("User not authorized to edit appointments of "+t);return e}},752:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.deleteAdmin=t.setAdmin=t.getAdmin=void 0;const n=o(54),i=o(311);t.getAdmin=async function(e){const t=n.firestore().collection(i.Collections.ADMIN),o=await t.doc(e).get();if(o.exists)return o.data()},t.setAdmin=async function(e){const t=n.firestore().collection(i.Collections.ADMIN);await t.doc(e.id).set(e)},t.deleteAdmin=async function(e){const t=n.firestore().collection(i.Collections.ADMIN);await t.doc(e).delete()}},988:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.updateAppointment=t.deleteAppointmentsByIds=t.getAppointmentsByDonorIdInTime=t.getAppointmentsCreatedByUserId=t.getAppointmentsByIds=void 0;const n=o(54),i=o(311),r=o(804);t.getAppointmentsByIds=async function(e){const t=n.firestore().collection(i.Collections.APPOINTMENTS),o=r.chunk(e,10).map((e=>t.where(n.firestore.FieldPath.documentId(),"in",e).get())),a=await Promise.all(o),s=r.flatMap(a,(e=>e.docs));return r.map(s,(e=>e.data()))},t.getAppointmentsCreatedByUserId=async function(e){return(await n.firestore().collection(i.Collections.APPOINTMENTS).where("creatorUserId","==",e).get()).docs.map((e=>Object.assign({id:e.id},e.data())))},t.getAppointmentsByDonorIdInTime=async function(e,t,o){const r=new Date(t);r.setDate(r.getDate()-7*o);const a=new Date(t);return a.setDate(a.getDate()+7*o),(await n.firestore().collection(i.Collections.APPOINTMENTS).where("donorId","==",e).where("donationStartTime",">=",r).where("donationStartTime","<=",a).get()).docs.map((e=>Object.assign({id:e.id},e.data())))},t.deleteAppointmentsByIds=async function(e){const t=n.firestore().batch(),o=n.firestore().collection(i.Collections.APPOINTMENTS);return e.map((e=>t.delete(o.doc(e)))),await t.commit()},t.updateAppointment=function(e){if(!e.id)throw new Error("Cant save appointment without id");return n.firestore().collection(i.Collections.APPOINTMENTS).doc(e.id).set(e)}},489:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.deleteDonor=t.updateDonor=t.getDonor=void 0;const n=o(54),i=o(311);t.getDonor=async function(e){const t=n.firestore().collection(i.Collections.DONORS),o=await t.doc(e).get();if(o.exists)return o.data()},t.updateDonor=async function(e){const t=n.firestore().collection(i.Collections.DONORS);await t.doc(e.id).set(e)},t.deleteDonor=async function(e){const t=n.firestore().collection(i.Collections.DONORS);await t.doc(e).delete()}},626:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(489),i=o(988);t.default=async function(e,t){var o;const r=null===(o=t.auth)||void 0===o?void 0:o.uid;if(!r)throw new Error("User must be authenticated to book donation");if(!await n.getDonor(r))throw Error("Donor not found");const a=(await i.getAppointmentsByIds(e.appointmentIds)).filter((e=>!e.donorId));if(0===a.length)throw new Error("No appointments to book");const s=a[0];if((await i.getAppointmentsByDonorIdInTime(r,s.donationStartTime.toDate(),4)).length>0)throw new Error("Donor has other donations in buffer");s.donorId=r,s.bookingTime=new Date,await i.updateAppointment(s)}},932:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(988),i=o(804);t.default=async function(e,t){var o;const r=null===(o=t.auth)||void 0===o?void 0:o.uid;if(!r)throw new Error("User must be authenticated to cancel appointment");if(!e.appointmentId)throw new Error("No appointment to cancel");const a=await n.getAppointmentsByIds([e.appointmentId]);if(1!==a.length)throw new Error("Appointment not found");const s=a[0];if(s.donorId!==r)throw new Error("Appointment to be deleted is not booked by donor");const d=i.omit(s,["donorId","bookingTime","confirmationTime"]);await n.updateAppointment(d)}},607:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.cancelAppointment=t.bookAppointment=t.saveAdmin=t.deleteAppointments=t.addNewAppointment=void 0;const n=o(576),i=o(979),r=o(946),a=o(762),s=o(626),d=o(932),l=o(54),c=o(685);l.initializeApp(n.config().firebase),l.firestore().settings({timestampsInSnapshots:!0}),t.addNewAppointment=c.handler(i.default),t.deleteAppointments=c.handler(r.default),t.saveAdmin=c.handler(a.default),t.bookAppointment=c.handler(s.default),t.cancelAppointment=c.handler(d.default)},54:e=>{e.exports=require("firebase-admin")},576:e=>{e.exports=require("firebase-functions")},804:e=>{e.exports=require("lodash")}},t={};return function o(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}(607)})());